---
- name: DHCP config update (GitHub -> candidate -> dhcpd -t -> deploy)
  hosts: all
  become: true
  gather_facts: false

  vars:
    remote_conf: "/etc/dhcp/dhcpd.conf"
    candidate_conf: "/etc/dhcp/dhcpd.conf.candidate"
    backup_conf: "{{ remote_conf }}.bak.{{ lookup('pipe','date +%F-%H%M%S') }}"

  tasks:
    - name: Ensure /tmp ok
      ansible.builtin.file:
        path: /tmp
        state: directory
        mode: "1777"

    - name: Copy candidate config to remote
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../configs/dhcpd.conf"
        dest: "{{ candidate_conf }}"
        owner: root
        group: root
        mode: "0644"
        
    - name: Restore SELinux context on candidate (best effort)
      ansible.builtin.command: "restorecon -v {{ candidate_conf }}"
      changed_when: false
      failed_when: false

    - name: Validate candidate config
      ansible.builtin.command: "dhcpd -t -cf {{ candidate_conf }}"
      register: dhcp_test
      changed_when: false

    - name: Fail if validation failed
      ansible.builtin.fail:
        msg: "dhcpd -t failed: {{ dhcp_test.stderr | default(dhcp_test.stdout) }}"
      when: dhcp_test.rc != 0

    - block:
        - name: Backup current config
          ansible.builtin.copy:
            src: "{{ remote_conf }}"
            dest: "{{ backup_conf }}"
            remote_src: true
            owner: root
            group: root
            mode: "0644"

        - name: Deploy candidate to live (copy, not mv)
          ansible.builtin.copy:
            src: "{{ candidate_conf }}"
            dest: "{{ remote_conf }}"
            remote_src: true
            owner: root
            group: root
            mode: "0644"

        - name: Restart DHCP service
          ansible.builtin.systemd:
            name: isc-dhcp-server
            state: restarted

      rescue:
        - name: Collect dhcpd status
          ansible.builtin.command: systemctl --no-pager -l status dhcpd
          register: dhcpd_status
          changed_when: false
          failed_when: false

        - name: Collect dhcpd journal
          ansible.builtin.command: journalctl --no-pager -l -xeu dhcpd --since "10 minutes ago"
          register: dhcpd_journal
          changed_when: false
          failed_when: false

        - name: Rollback config from backup
          ansible.builtin.copy:
            src: "{{ backup_conf }}"
            dest: "{{ remote_conf }}"
            remote_src: true
            owner: root
            group: root
            mode: "0644"

        - name: Restart DHCP after rollback (best effort)
          ansible.builtin.systemd:
            name: dhcpd
            state: restarted
          failed_when: false

        - name: Fail with details (so Jenkins console shows root cause)
          ansible.builtin.fail:
            msg: |
              dhcpd restart failed; rolled back to previous config.
              --- systemctl status ---
              {{ dhcpd_status.stdout }}
              --- journalctl ---
              {{ dhcpd_journal.stdout }}
